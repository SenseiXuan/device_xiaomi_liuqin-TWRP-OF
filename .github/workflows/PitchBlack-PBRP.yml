name: PitchBlack [PBRP]
on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'PBRP Manifest Branch'
        required: true
        default: 'android-14.0'
        type: choice
        options:
          - android-14.0
          - android-12.1
          - android-11.0
      DEVICE_TREE:
        description: 'Custom Recovery Tree URL'
        required: true
        default: 'https://github.com/xccxxcys/device_xiaomi_liuqin-TWRP-OF'
      DEVICE_TREE_BRANCH:
        description: 'Custom Recovery Tree Branch'
        required: true
        default: 'main'
      DEVICE_NAME:
        description: 'Device Codename (match PRODUCT_DEVICE)'
        required: true
        default: 'liuqin'
      DEVICE_PATH:
        description: 'Device Path (match BoardConfig.mk)'
        required: true
        default: 'device/xiaomi/liuqin'
      BUILD_TARGET:
        description: 'Build Target (use "pbrp" for Android 11+)'
        required: true
        default: 'recovery'
        type: choice
        options:
          - pbrp
          - boot
          - recovery
          - vendorboot

jobs:
  build:
    name: Build PBRP for ${{ inputs.DEVICE_NAME }}
    runs-on: ubuntu-latest
    env:
      PBRP_VERSION: "4.0"
      BUILD_DATE: ${{ format('{0}-{1}', github.sha_short, github.run_id) }}  # Á≤æÁÆÄÂîØ‰∏ÄÊ†áËØÜ
      OUTPUT_DIR: ${{ github.workspace }}/android-recovery/out/target/product/${{ inputs.DEVICE_NAME }}
      CCACHE_MAXSIZE: "5G"
    permissions:
      contents: write

    steps:
      - name: üìã Show Build Configuration
        run: |
          echo "=== PBRP Build Config ==="
          echo "Manifest Branch: ${{ inputs.MANIFEST_BRANCH }}"
          echo "Device Tree: $ echo "Device Tree: ${{ inputs.DEVICE_TREE }} (${{ inputs.DEVICE_TREE_BRANCH }})"
          echo "Device: ${{ inputs.DEVICE_NAME }} (Path: ${{ inputs.DEVICE_PATH }})"
          echo "Build Target: ${{ inputs.BUILD_TARGET }}"
          echo "Build ID: ${{ env.BUILD_DATE }}"
          echo "========================"

      - name: üßπ Cleanup & Maximize Resources
        uses: rokibhasansagar/slimhub_actions@main

      - name: üõ†Ô∏è Setup Build Dependencies
        run: |
          set -eo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt update && sudo apt install -y git-lfs  # ‰øùÁïôaptÂü∫Á°Ä‰æùËµñÔºårepoÊâãÂä®ÂÆâË£Ö
          # Áªü‰∏ÄGitÈÖçÁΩÆÔºàÂêàÂπ∂ÈáçÂ§çÈÖçÁΩÆÔºâ
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: ‚òï Setup Java Environment
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: ${{ inputs.MANIFEST_BRANCH == 'android-14.0' && '17' || '8' }}

      - name: üì• Install Git-Repo (Latest Version)
        run: |
          mkdir -p ~/bin
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "~/bin" >> $GITHUB_PATH

      - name: üêç Install Python2 (Legacy Branches)
        if: inputs.MANIFEST_BRANCH == 'android-11.0' || inputs.MANIFEST_BRANCH == 'android-12.1'
        run: |
          sudo apt install -y --no-install-recommends python2 python-is-python2
          python --version

      - name: üöÄ Initialize & Sync Source
        run: |
          set -eo pipefail
          mkdir -p android-recovery && cd android-recovery
          # ÁÆÄÂåñrepo initÂëΩ‰ª§ÔºàÂéªÈô§Â§ö‰ΩôÂèçÊñúÊù†Ôºâ
          repo init --depth=1 -u https://github.com/mlm-games/manifest_pb.git -b ${{ inputs.MANIFEST_BRANCH }} --single-branch --no-tags
          # ‰øùÁïôÁî®Êà∑ÊåáÂÆöÁöÑÂêåÊ≠•‰ºòÂåñÂèÇÊï∞
          repo sync -j$(nproc --all) --force-sync -c --no-clone-bundle --no-tags
          echo "Source sync completed successfully"

      - name: üì± Clone Device Tree
        run: |
          set -eo pipefail
          cd android-recovery
          mkdir -p $(dirname ${{ inputs.DEVICE_PATH }})
          git clone --depth=1 ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ${{ inputs.DEVICE_PATH }}
          # Á≤æÁÆÄCommit IDËé∑ÂèñÂëΩ‰ª§
          echo "COMMIT_ID=$(cd ${{ inputs.DEVICE_PATH }} && git rev-parse --short HEAD)" >> $GITHUB_ENV
          # Âü∫Á°ÄÊ†°È™åÔºà‰øùÁïôÊ†∏ÂøÉÊ£ÄÊµãÔºâ
          [ ! -f "${{ inputs.DEVICE_PATH }}/Android.mk" ] && [ ! -f "${{ inputs.DEVICE_PATH }}/Android.bp" ] && { echo "Error: Missing Android.mk/Android.bp"; exit 1; }

      - name: üîç Detect Device Makefile
        run: |
          set -eo pipefail
          cd android-recovery
          # ‰øùÁïôÁî®Êà∑ÈúÄË¶ÅÁöÑMakefileÊ£ÄÊµãÈÄªËæëÔºåÁ≤æÁÆÄÊù°‰ª∂Âà§Êñ≠
          if [ -f "${{ inputs.DEVICE_PATH }}/pb_${{ inputs.DEVICE_NAME }}.mk" ]; then
            echo "DEVICE_MAKEFILE=pb_${{ inputs.DEVICE_NAME }}" >> $GITHUB_ENV
          elif [ -f "${{ inputs.DEVICE_PATH }}/twrp_${{ inputs.DEVICE_NAME }}.mk" ]; then
            echo "DEVICE_MAKEFILE=twrp_${{ inputs.DEVICE_NAME }}" >> $GITHUB_ENV
          elif [ -f "${{ inputs.DEVICE_PATH }}/omni_${{ inputs.DEVICE_NAME }}.mk" ]; then
            echo "DEVICE_MAKEFILE=omni_${{ inputs.DEVICE_NAME }}" >> $GITHUB_ENV
          else
            echo "Error: No valid Makefile (pb/twrp/omni_${{ inputs.DEVICE_NAME }}.mk)"; exit 1
          fi
          echo "Detected Makefile: ${{ env.DEVICE_MAKEFILE }}.mk"

      - name: ‚ö° Setup ccache (Speed Up Build)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true
          max-size: ${{ env.CCACHE_MAXSIZE }}
          key: pbrp-${{ inputs.DEVICE_NAME }}-${{ inputs.MANIFEST_BRANCH }}  # Á≤æÁÆÄÁºìÂ≠òÈîÆ
          restore-keys: |
            pbrp-${{ inputs.DEVICE_NAME }}-
            pbrp-

      - name: üèóÔ∏è Build PitchBlack (with Logs)
        run: |
          set -eo pipefail
          cd android-recovery
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          export USE_CCACHE=1  # Á≤æÁÆÄccacheÈÖçÁΩÆÔºà‰æùËµñactionËá™Âä®ËÆæÁΩÆÔºâ
          ccache -s
          lunch ${{ env.DEVICE_MAKEFILE }}-eng
          # ÁÆÄÂåñÊûÑÂª∫ÂëΩ‰ª§ÔºàÂêàÂπ∂Êù°‰ª∂Âà§Êñ≠Ôºâ
          [ "${{ inputs.BUILD_TARGET }}" = "pbrp" ] && mka pbrp -j$(nproc --all) 2>&1 | tee build.log || mka ${{ inputs.BUILD_TARGET }}image -j$(nproc --all) 2>&1 | tee build.log
          # ÁÆÄÂåñËæìÂá∫Ê†°È™å‰∏éÈáçÂëΩÂêç
          [ ! -d "$OUTPUT_DIR" ] && { echo "Error: Output directory not found"; exit 1; }
          if [ "${{ inputs.BUILD_TARGET }}" = "pbrp" ]; then
            mv "$OUTPUT_DIR/recovery.img" "$OUTPUT_DIR/PBRP-${{ env.PBRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}.img" 2>/dev/null || true
            mv "$OUTPUT_DIR/PBRP-${{ inputs.DEVICE_NAME }}.zip" "$OUTPUT_DIR/PBRP-${{ env.PBRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}.zip" 2>/dev/null || true
          else
            mv "$OUTPUT_DIR/${{ inputs.BUILD_TARGET }}.img" "$OUTPUT_DIR/PBRP-${{ env.PBRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}-${{ inputs.BUILD_TARGET }}.img" 2>/dev/null || true
          fi
          ccache -s
          echo "Build completed successfully!"

      - name: üìä Generate Build Info & MD5
        run: |
          set -eo pipefail
          cd ${{ env.OUTPUT_DIR }}
          # Á≤æÁÆÄINFO.txtÔºà‰øùÁïôÊ†∏ÂøÉ‰ø°ÊÅØÔºåÂéªÈô§ÂÜó‰ΩôÂ≠óÊÆµÔºâ
          cat > INFO.txt <<EOF
          PBRP Build Information
          ===============
          Version: ${{ env.PBRP_VERSION }}
          Manifest: ${{ inputs.MANIFEST_BRANCH }}
          Device: ${{ inputs.DEVICE_NAME }}
          Device Tree: ${{ inputs.DEVICE_TREE }} (${{ inputs.DEVICE_TREE_BRANCH }})
          Commit: ${{ env.COMMIT_ID }}
          Build Target: ${{ inputs.BUILD_TARGET }}
          Build ID: ${{ env.BUILD_DATE }}
          
          MD5 Checksums:
          $(md5sum PBRP-*.img PBRP-*.zip 2>/dev/null)
          EOF
          cat INFO.txt

      - name: üì§ Upload Build Artifacts
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.OUTPUT_DIR }}/PBRP-*.img
            ${{ env.OUTPUT_DIR }}/PBRP-*.zip
            ${{ env.OUTPUT_DIR }}/ramdisk-recovery.*
            ${{ env.OUTPUT_DIR }}/INFO.txt
            ${{ github.workspace }}/android-recovery/build.log
          name: PBRP ${{ env.PBRP_VERSION }} - ${{ inputs.DEVICE_NAME }} - ${{ env.BUILD_DATE }}
          tag_name: pbrp-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
          body: |
            ## Unofficial PBRP Build for ${{ inputs.DEVICE_NAME }}
            - **Manifest Branch**: ${{ inputs.MANIFEST_BRANCH }}
            - **Device Tree**: [${{ inputs.DEVICE_TREE_BRANCH }}](${{ inputs.DEVICE_TREE }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
            - **Commit**: [${{ env.COMMIT_ID }}](${{ inputs.DEVICE_TREE }}/commit/${{ env.COMMIT_ID }})
            - **Build Target**: ${{ inputs.BUILD_TARGET }}
            - **Build ID**: ${{ env.BUILD_DATE }}
            
            ### Notes
            - Verify MD5 before flashing
            - Attach build.log when reporting issues
          prerelease: false

      - name: üö® Upload Failure Logs (On Error)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: PBRP-Failure-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
          path: ${{ github.workspace }}/android-recovery/build.log
          retention-days: 7  # Áº©Áü≠‰øùÁïôÊó∂Èó¥ÔºåËäÇÁúÅÂ≠òÂÇ®Á©∫Èó¥
